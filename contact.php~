<?php

// This file manages the shopping cart.
// This script is begun in Chapter 9.

// Require the configuration before any PHP code:
require('../config.inc.php');

// Include the header file:
$page_title = 'Coffee - Contact Page';
include('./includes/header.html');

// Require the database connection:
require (MYSQL);

// For storing errors:
$contact_errors = array();

// Need the utility functions:
include('./includes/product_functions.inc.php');

// Check for a form submission:
if ($_SERVER['REQUEST_METHOD'] === 'POST') {

	// Magic quotes for the first name:
	if (get_magic_quotes_gpc()) {
		$_POST['first_name'] = stripslashes($_POST['first_name']);
	}

	// Check for a first name:
	if (preg_match ('/^[A-Z \'.-]{2,20}$/i', $_POST['first_name'])) {
		$fn = $_POST['first_name'];
	} else {
		$contact_errors['first_name'] = 'Please enter your first name!';
	}

	// Magic quotes for the last name:
	if (get_magic_quotes_gpc()) {
		$_POST['last_name'] = stripslashes($_POST['last_name']);
	}

	// Check for a last name:
	if (preg_match ('/^[A-Z \'.-]{2,40}$/i', $_POST['last_name'])) {
		$ln  = $_POST['last_name'];
	} else {
		$contact_errors['last_name'] = 'Please enter your last name!';
	}
	
	// Check for and validate the email address:
	if (!filter_var($_POST['email'], FILTER_VALIDATE_EMAIL)) {
		$e = $_POST['email'];
	} else {
		$contact_errors['email'] = 'Please enter a valid email address!';
	}
	
	// Magic quotes for the body comments:
	if (get_magic_quotes_gpc()) {
		$_POST['comments'] = stripslashes($_POST['comments']);
	}
	
	// Check for the e-mail comments:
	if (preg_match ('/[a-zA-Z0-9.-]/', $_POST['comments'])) {
		$c  = $_POST['comments'];
	} else {
		$contact_errors['comments'] = 'Please enter your comments here';
	}
	
	// Set the subject line:
	$subject = "Contact Form Submission";
	
	// Create the message body:
	$body = "Name: {$fn}\n\nComments: {$c}";

	// Make the message body no longer than 1000 characters long:
	$message = wordwrap($body, 1000);
	
	// Create the header for the contacting email address:
	$headers = "From: " . $e . "\r\n";
	
	// Send the email to Postfix with the admin contact email constant from configuration file:
	$sent = mail(CONTACT_EMAIL, $subject, $message, $headers);
	
	if($sent == true) {
			echo '<p style= "font-weight: bold; color: #00F">Thanks for your message! Someone will be in touch shortly.</p>';
	}
	else
	{
		echo '<p style= "font-weight: bold; color: #C00" >Sorry, your message could not be sent!</p>';
	}

	// Clear $_POST (So that the form's not sticky):
	$_POST = array();

} 
// End of REQUEST_METHOD IF:

// Include the contact page view:
include('./views/contact.html');

// Finish the HTML page:
include('./includes/footer.html');
?>
